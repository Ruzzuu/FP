===============================================
COMPREHENSIVE TESTING COMMANDS FOR AZURE VM
Copy-paste satu per satu ke terminal SSH
===============================================

# 0. SSH ke Azure VM
ssh azureuser@20.2.83.176

# 1. Masuk ke project directory
cd ~/fp_cc/FP

# 2. Check current commit
echo "=== Current commit ===" && git log --oneline -1

# 3. Pull latest code
echo "=== Pulling latest code ===" && git pull origin main

# 4. Copy .env.azure to .env
echo "=== Setting up environment ===" && cp .env.azure .env && cat .env

# 5. Stop containers
echo "=== Stopping containers ===" && docker compose down

# 6. Remove old images (optional but recommended)
echo "=== Removing old images ===" && docker compose rm -f

# 7. Rebuild ALL containers
echo "=== Rebuilding ALL containers ===" && docker compose build --no-cache

# 8. Start containers
echo "=== Starting containers ===" && docker compose up -d

# 9. Wait for services to be ready
echo "=== Waiting 30 seconds for services ===" && sleep 30

# 10. Check container status
echo "=== Container status ===" && docker compose ps

# 11. Check backend logs
echo "=== Backend logs (last 30 lines) ===" && docker compose logs backend --tail 30

# 12. Check if backend is responding
echo "=== Testing backend API ===" && curl -s http://localhost:5001/api | jq .

# 13. Test login (use your actual credentials)
echo "=== Testing login ===" && TOKEN=$(curl -s -X POST http://localhost:5001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"didi@example.com","password":"Test123!@#"}' | jq -r '.accessToken')
echo "Token (first 50 chars): ${TOKEN:0:50}..."

# 14. Create test image
echo "=== Creating test image ===" && echo "iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAFUlEQVR42mNk+M9Qz0AEYBxVSF+FABJADveWkH6oAAAAAElFTkSuQmCC" | base64 -d > /tmp/test-upload.png

# 15. Test create post with image
echo "=== Creating post with image ===" && curl -X POST http://localhost:5001/api/posts \
  -H "Authorization: Bearer $TOKEN" \
  -F "title=Test Post with Image" \
  -F "content=This post has an image attachment" \
  -F "published=true" \
  -F "file=@/tmp/test-upload.png" | jq .

# 16. Get all posts and check fileUrl
echo "=== Getting posts list ===" && curl -s http://localhost:5001/api/posts | jq '.posts[] | {id, title, fileUrl}'

# 17. Check if uploaded files exist
echo "=== Uploaded files in container ===" && docker compose exec backend ls -lah /app/uploads/ | tail -10

# 18. Test file accessibility from OUTSIDE (critical!)
echo "=== Testing external file access ===" && FIRST_FILE_URL=$(curl -s http://localhost:5001/api/posts | jq -r '.posts[0].fileUrl')
echo "File URL: $FIRST_FILE_URL"
if [ ! -z "$FIRST_FILE_URL" ] && [ "$FIRST_FILE_URL" != "null" ]; then
  curl -I "$FIRST_FILE_URL"
fi

# 19. Check frontend logs
echo "=== Frontend logs (last 20 lines) ===" && docker compose logs frontend --tail 20

# 20. Test from your local machine (run on your laptop, NOT on Azure VM)
# Open browser: http://20.2.83.176:3001
# Login and check:
# - Posts list shows thumbnail images ✓
# - Click "Has attachment" opens file ✓
# - Click post title goes to detail ✓
# - In post detail, image displays ✓
# - Create new post with image ✓
# - Edit post and change image ✓

===============================================
EXPECTED RESULTS:
===============================================
1. All containers should be "Up" and "healthy"
2. Backend API returns: {"message":"Backend API","status":"running","version":"1.0.0"}
3. Login returns accessToken
4. Create post returns JSON with fileUrl = "http://20.2.83.176:5001/uploads/xxxxx.png"
5. GET /posts returns fileUrl with FULL URL (not just /uploads/...)
6. curl -I to fileUrl returns "HTTP/1.1 200 OK"
7. Files exist in /app/uploads/

===============================================
IF FILEURL IS WRONG (still localhost or missing):
===============================================
# Check environment variables in backend
docker compose exec backend printenv | grep BASE_URL

# Should show: BASE_URL=http://20.2.83.176:5001

# If not, stop containers and rebuild:
docker compose down
cat .env  # verify BASE_URL is correct
docker compose build backend --no-cache
docker compose up -d

===============================================
DEBUGGING TIPS:
===============================================
# Watch live logs
docker compose logs -f backend

# Exec into backend container
docker compose exec backend sh
ls -la /app/uploads/
cat /app/.env || env | grep BASE

# Check CORS (if browser blocks)
docker compose logs backend | grep -i cors

# Test image load from browser console
# Open browser dev tools (F12) -> Console:
# fetch('http://20.2.83.176:5001/uploads/xxxxx.png').then(r => console.log(r.status))

===============================================
